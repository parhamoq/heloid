<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÙˆØ¦ÛŒÚ† ÙˆØ¶Ø¹ÛŒØª Ø³Ø§Ø¯Ù‡</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Ø³Ø§Ø¯â€ŒÙ‡â€ŒØªØ± Ùˆ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Transition Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² */
        .toggle-button {
            transition: all 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen p-4 font-sans">

    <div id="loginScreen" class="absolute inset-0 bg-gray-900 bg-opacity-95 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl text-center w-full max-w-sm">
            <h2 class="text-2xl font-bold text-indigo-600 mb-4">ğŸ”’ ÙˆØ±ÙˆØ¯</h2>
            <p id="pinLoadingStatus" class="text-sm text-gray-500 mb-4">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù„ÛŒØ¯...</p>
            
            <input 
                type="password" 
                id="pinInput" 
                maxlength="4" 
                placeholder="Ú©Ø¯ 4 Ø±Ù‚Ù…ÛŒ" 
                disabled
                class="w-full text-center border-2 border-gray-300 rounded-lg p-3 text-2xl outline-none mb-4 opacity-50 transition" 
            />
            <button id="pinSubmitButton" disabled class="w-full bg-indigo-400 text-white font-bold py-3 rounded-lg transition duration-200 shadow-md">
                ÙˆØ±ÙˆØ¯
            </button>
            <p id="pinError" class="text-red-500 text-sm mt-3 hidden">Ú©Ø¯ Ø§Ù…Ù†ÛŒØªÛŒ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª.</p>
        </div>
    </div>
    
    <div id="app" class="w-full max-w-sm p-6 bg-white rounded-xl shadow-2xl text-center flex flex-col items-center hidden">
        <h1 class="text-2xl font-bold text-gray-800 mb-6">Ø³ÙˆØ¦ÛŒÚ† Ù‡ÙˆØ´Ù…Ù†Ø¯</h1>

        <div id="statusDisplay" class="text-xl font-semibold p-3 w-full rounded-lg mb-6 transition-colors duration-500">
            Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...
        </div>

        <button id="toggleButton" disabled class="toggle-button text-white font-bold py-3 px-6 rounded-full opacity-50 w-full">
            ...
        </button>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
        // ÙØ±Ø¶ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… config.js Ø´Ø§Ù…Ù„ Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² Ø§Ø³Øª
        import { supabaseUrl, supabaseAnonKey } from './config.js'; 

        // --- ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø«Ø§Ø¨Øª ---
        const TABLE_NAME = 'toggle_status';
        const STATUS_ROW_ID = 1; // Ù‡Ù…ÛŒØ´Ù‡ Ø±Ø¯ÛŒÙ Ø§ÙˆÙ„ Ø±Ø§ Ø¢Ù¾Ø¯ÛŒØª Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
        const SECRETS_TABLE_NAME = 'app_config';
        const SECRETS_ROW_ID = 1;
        
        // --- Ø¹Ù†Ø§ØµØ± DOM ---
        const app = document.getElementById('app');
        const loginScreen = document.getElementById('loginScreen');
        const pinInput = document.getElementById('pinInput');
        const pinSubmitButton = document.getElementById('pinSubmitButton');
        const pinError = document.getElementById('pinError');
        const pinLoadingStatus = document.getElementById('pinLoadingStatus');
        const statusDisplay = document.getElementById('statusDisplay');
        const toggleButton = document.getElementById('toggleButton');

        let supabase;
        let secretPin = null;

        // --- ØªÙˆØ§Ø¨Ø¹ UI ---
        
        /** Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ UI Ø¨Ø± Ø§Ø³Ø§Ø³ ÙˆØ¶Ø¹ÛŒØª Ø¬Ø¯ÛŒØ¯ **/
        const updateUI = (isActive) => {
            const buttonState = {
                true: { text: "Ø®Ø§Ù…ÙˆØ´ Ú©Ù†", classes: 'bg-red-600 hover:bg-red-700' },
                false: { text: "Ø±ÙˆØ´Ù† Ú©Ù†", classes: 'bg-green-600 hover:bg-green-700' },
                null: { text: "Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯", classes: 'bg-gray-400 opacity-50', disabled: true }
            };

            const displayState = {
                true: { text: "ÙˆØ¶Ø¹ÛŒØª: Ø±ÙˆØ´Ù†", classes: 'bg-green-100 text-green-700 ring-4 ring-green-300' },
                false: { text: "ÙˆØ¶Ø¹ÛŒØª: Ø®Ø§Ù…ÙˆØ´", classes: 'bg-red-100 text-red-700 ring-4 ring-red-300' },
                null: { text: "Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...", classes: 'bg-gray-100 text-gray-500' }
            };

            const state = isActive === true ? 'true' : (isActive === false ? 'false' : 'null');

            statusDisplay.textContent = displayState[state].text;
            statusDisplay.className = `text-xl font-semibold p-3 w-full rounded-lg mb-6 transition-colors duration-500 ${displayState[state].classes}`;
            
            toggleButton.textContent = buttonState[state].text;
            toggleButton.className = `toggle-button text-white font-bold py-3 px-6 rounded-full w-full ${buttonState[state].classes}`;
            toggleButton.disabled = buttonState[state].disabled || false;
            
            if (isActive !== null) {
                toggleButton.dataset.isActive = isActive;
            }
        };

        // --- ØªÙˆØ§Ø¨Ø¹ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ (Supabase) ---

        /** Ø®ÙˆØ§Ù†Ø¯Ù† Ú©Ù„ÛŒØ¯ Ø§Ù…Ù†ÛŒØªÛŒ (PIN) Ø§Ø² Ø¯ÛŒØªØ§Ø¨ÛŒØ³ **/
        async function fetchSecretPin() {
            pinLoadingStatus.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù„ÛŒØ¯ Ø§Ù…Ù†ÛŒØªÛŒ...";
            try {
                const { data, error } = await supabase
                    .from(SECRETS_TABLE_NAME)
                    .select('pin_code')
                    .eq('id', SECRETS_ROW_ID)
                    .single();

                if (error || !data || !data.pin_code) throw new Error("PIN not found or RLS error.");

                secretPin = data.pin_code;
                pinLoadingStatus.textContent = "Ú©Ø¯ Ø§Ù…Ù†ÛŒØªÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:";
                
                // ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø§Ù„Ù…Ø§Ù†â€ŒÙ‡Ø§ÛŒ ÙˆØ±ÙˆØ¯
                pinInput.disabled = false;
                pinInput.classList.remove('opacity-50');
                pinSubmitButton.disabled = false;
                pinSubmitButton.className = 'w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition duration-200 shadow-md hover:shadow-lg';
            } catch (error) {
                console.error("Error fetching PIN:", error);
                pinLoadingStatus.textContent = "âŒ Ø®Ø·Ø§: Ú©Ù„ÛŒØ¯ Ø§Ù…Ù†ÛŒØªÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯.";
                pinSubmitButton.disabled = true;
            }
        }

        /** Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¶Ø¹ÛŒØª Ø§ÙˆÙ„ÛŒÙ‡ Ø³ÙˆØ¦ÛŒÚ† **/
        async function fetchInitialStatus() {
            updateUI(null); // Ù†Ù…Ø§ÛŒØ´ Ø­Ø§Ù„Øª "Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„"

            const { data, error } = await supabase
                .from(TABLE_NAME)
                .select('is_active')
                .eq('id', STATUS_ROW_ID)
                .maybeSingle(); // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² maybeSingle Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø±Ø¯ÛŒÙ

            if (error) {
                console.error("Error fetching status:", error);
                statusDisplay.textContent = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¶Ø¹ÛŒØª Ø§ÙˆÙ„ÛŒÙ‡.";
                updateUI(null);
                return;
            } 

            if (!data) {
                // Ø§Ú¯Ø± Ø±Ø¯ÛŒÙÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ØŒ ÛŒÚ© Ø±Ø¯ÛŒÙ Ø§ÙˆÙ„ÛŒÙ‡ (Ø±ÙˆØ´Ù†) Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†
                console.log("Status row not found. Inserting initial status (true).");
                const { error: insertError } = await supabase.from(TABLE_NAME).insert({ id: STATUS_ROW_ID, is_active: true });
                if (insertError) {
                    console.error("Error inserting initial status:", insertError);
                    statusDisplay.textContent = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ ÙˆØ¶Ø¹ÛŒØª Ø§ÙˆÙ„ÛŒÙ‡.";
                    updateUI(null);
                    return;
                }
                updateUI(true);
            } else {
                updateUI(data.is_active);
            }
        }

        /** Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ù†ÙˆÙ†Ø¯Ù‡ Ø¨Ù„Ø§Ø¯Ø±Ù†Ú¯ (Real-time) **/
        function setupRealtimeListener() {
            supabase.channel('status_channel')
                .on('postgres_changes', { 
                    event: 'UPDATE', 
                    schema: 'public', 
                    table: TABLE_NAME,
                    filter: `id=eq.${STATUS_ROW_ID}` 
                }, (payload) => {
                    console.log('Realtime change received:', payload);
                    // Realtime Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ UI Ø±Ø§ Ø¨Ù‡â€ŒØ±ÙˆØ² Ù…ÛŒâ€ŒÚ©Ù†Ø¯
                    updateUI(payload.new.is_active);
                })
                .subscribe((status) => {
                    if (status !== 'SUBSCRIBED') {
                        console.error('Realtime subscription failed or had an error:', status);
                        // Ø§Ú¯Ø± Realtime Ø¯Ú†Ø§Ø± Ù…Ø´Ú©Ù„ Ø´Ø¯ØŒ ÛŒÚ© Ø¨Ø§Ø± Ø¯ÛŒÚ¯Ø± ÙˆØ¶Ø¹ÛŒØª Ø±Ø§ Ø¨Ø®ÙˆØ§Ù† ØªØ§ Ø­Ø¯Ø§Ù‚Ù„ Ø¯Ú©Ù…Ù‡ ÙØ¹Ø§Ù„ Ø´ÙˆØ¯
                        if (status === 'CHANNEL_ERROR') {
                             statusDisplay.textContent = "âš ï¸ Ø§Ø®Ø·Ø§Ø±: Ø®Ø·Ø§ÛŒ Realtime. Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒâ€ŒÙ‡Ø§ Ø¨Ø§ ØªØ§Ø®ÛŒØ± Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.";
                        }
                    }
                });
        }

        /** Ø¬Ø§Ø¨Ø¬Ø§ÛŒÛŒ ÙˆØ¶Ø¹ÛŒØª Ùˆ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ (Ø±ÙØ¹ Ù…Ø´Ú©Ù„ Ø§ØµÙ„ÛŒ) **/
        async function toggleStatus() {
            const currentStatus = toggleButton.dataset.isActive === 'true';
            const newStatus = !currentStatus;
            
            // Ù†Ù…Ø§ÛŒØ´ Ø­Ø§Ù„Øª "Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡..." Ùˆ ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡
            toggleButton.disabled = true;
            toggleButton.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡...";
            statusDisplay.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ ØªØºÛŒÛŒØ± Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³..."; // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø§Ù†ØªØ¸Ø§Ø±

            try {
                const { error } = await supabase
                    .from(TABLE_NAME)
                    .update({ is_active: newStatus })
                    .eq('id', STATUS_ROW_ID);
                
                if (error) throw error;
                
                console.log(`Status successfully toggled to: ${newStatus}`);
                
                // ğŸš€ Ø­Ù„ Ù…Ø´Ú©Ù„ Ø§ØµÙ„ÛŒ: 
                // Ø¨Ù„Ø§ÙØ§ØµÙ„Ù‡ UI Ø±Ø§ Ø¨Ø§ ÙˆØ¶Ø¹ÛŒØª Ø¬Ø¯ÛŒØ¯ (Ú©Ù‡ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø«Ø¨Øª Ø´Ø¯Ù‡) Ø¨Ù‡â€ŒØ±ÙˆØ² Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ….
                // Ø§Ú¯Ø± Realtime Ø³Ø±ÛŒØ¹â€ŒØªØ± Ø¹Ù…Ù„ Ú©Ù†Ø¯ØŒ Ø§ÛŒÙ† ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø§Ø¶Ø§ÙÛŒ Ø§Ø³Øª Ø§Ù…Ø§ ØªØ¶Ù…ÛŒÙ† Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ø¯Ú©Ù…Ù‡ Ú¯ÛŒØ± Ù†Ú©Ù†Ø¯.
                updateUI(newStatus); 
                
            } catch (error) {
                console.error("Error toggling status:", error);
                // Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ØŒ Ø¯Ú©Ù…Ù‡ Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ÙØ¹Ø§Ù„ Ùˆ ÙˆØ¶Ø¹ÛŒØª Ø±Ø§ Ø¨Ø§ Ø¢Ø®Ø±ÛŒÙ† Ø­Ø§Ù„Øª Ø§Ø² Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù‡Ù…Ú¯Ø§Ù… Ú©Ù†
                statusDisplay.textContent = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ÙˆØ¶Ø¹ÛŒØª. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.";
                fetchInitialStatus(); 
            }
        }

        // --- ØªÙˆØ§Ø¨Ø¹ Ú©Ù†ØªØ±Ù„ Ø¨Ø±Ù†Ø§Ù…Ù‡ ---

        /** Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø¯ Ø§Ù…Ù†ÛŒØªÛŒ Ùˆ Ø´Ø±ÙˆØ¹ Ù…Ù†Ø·Ù‚ Ø§ØµÙ„ÛŒ **/
        function checkPIN() {
            pinError.classList.add('hidden');

            if (pinInput.value === secretPin) { 
                loginScreen.classList.add('hidden');
                app.classList.remove('hidden'); 
                
                fetchInitialStatus(); // 1. Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¶Ø¹ÛŒØª Ø§ÙˆÙ„ÛŒÙ‡
                setupRealtimeListener(); // 2. Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Realtime
            } else {
                pinError.classList.remove('hidden');
                pinInput.value = ''; 
            }
        }
        
        /** Ø´Ø±ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡ **/
        function initializeApp() {
            try {
                // Ø³Ø§Ø®Øª Ú©Ù„Ø§ÛŒÙ†Øª Ø³ÙˆÙ¾Ø§Ø¨ÛŒØ³
                supabase = createClient(supabaseUrl, supabaseAnonKey);
                
                // Ú¯ÙˆØ´â€ŒØ¯Ù‡Ù†Ø¯Ù‡â€ŒÙ‡Ø§
                pinSubmitButton.addEventListener('click', checkPIN);
                pinInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') checkPIN();
                });
                toggleButton.addEventListener('click', toggleStatus);

                // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù„ÛŒØ¯ Ø§Ù…Ù†ÛŒØªÛŒ Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯
                fetchSecretPin();
            } catch (error) {
                 console.error("Supabase Client Initialization Error:", error);
                 pinLoadingStatus.textContent = "âŒ Ø®Ø·Ø§ÛŒ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø³ÙˆÙ¾Ø§Ø¨ÛŒØ³.";
            }
        }

        window.onload = initializeApp;

    </script>
</body>
</html>
