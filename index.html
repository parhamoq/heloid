<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÙˆØ¦ÛŒÚ† ÙˆØ¶Ø¹ÛŒØª Ù‡ÙˆØ´Ù…Ù†Ø¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ù†Ù…Ø§ÛŒØ´ Ø¯Ù‡Ù†Ø¯Ù‡ Ù…Ø¯Ù„ Ø³Ù‡ Ø¨Ø¹Ø¯ÛŒ -->
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        .font-sans { font-family: 'Inter', Tahoma, sans-serif; }
        .toggle-button { transition: all 0.3s ease-in-out; }
        
        /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø§Ø®ØªØµØ§ØµÛŒ Ù…Ø¯Ù„ Ø³Ù‡ Ø¨Ø¹Ø¯ÛŒ */
        model-viewer {
            width: 100%;
            height: 400px;
            background-color: #f3f4f6;
            border-radius: 0.75rem;
            --poster-color: transparent;
        }

        /* Ø§Ø³ØªØ§ÛŒÙ„ Ø§Ø³Ù„Ø§ÛŒØ¯Ø± */
        input[type=range] {
            direction: ltr;
        }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen p-4 font-sans">

    <!-- ØµÙØ­Ù‡ Ù„Ø§Ú¯ÛŒÙ† -->
    <div id="loginScreen" class="absolute inset-0 bg-gray-900 bg-opacity-95 flex items-center justify-center p-4 z-40 overflow-y-auto">
        <div class="bg-white p-6 rounded-xl shadow-2xl text-center w-full max-w-sm my-auto">
            <h2 class="text-2xl font-bold text-indigo-600 mb-4">ğŸ”’ ÙˆØ±ÙˆØ¯ / ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h2>

            <div id="pinLoginForm">
                <p id="pinLoadingStatus" class="text-sm text-gray-500 mb-4">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù„ÛŒØ¯...</p>
                <input 
                    type="password" 
                    id="pinInput" 
                    maxlength="4" 
                    placeholder="Ú©Ø¯ 4 Ø±Ù‚Ù…ÛŒ" 
                    disabled
                    class="w-full text-center border-2 border-gray-300 rounded-lg p-3 text-2xl outline-none mb-4 opacity-50 transition" 
                />
                <button id="pinSubmitButton" disabled class="w-full bg-indigo-400 text-white font-bold py-3 rounded-lg transition duration-200 shadow-md">
                    ÙˆØ±ÙˆØ¯
                </button>
                <p id="pinError" class="text-red-500 text-sm mt-3 hidden">Ú©Ø¯ Ø§Ù…Ù†ÛŒØªÛŒ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª.</p>
            </div>

            <div class="mt-6 pt-4 border-t border-gray-200 space-y-3">
                <button id="setupButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg transition duration-200 shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                    <span>âš™ï¸</span> ØªÙ†Ø¸ÛŒÙ…Ø§Øª Wi-Fi Ø¨Ø±Ø¯
                </button>
                
                <button id="show3dButton" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg transition duration-200 shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                    <span>ğŸ§Š</span> Ù†Ù…Ø§ÛŒØ´ Ù…Ø¯Ù„ Ø³Ù‡ Ø¨Ø¹Ø¯ÛŒ Ù…Ø­ØµÙˆÙ„
                </button>
            </div>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ Ù†Ù…Ø§ÛŒØ´ Ù…Ø¯Ù„ Ø³Ù‡ Ø¨Ø¹Ø¯ÛŒ -->
    <div id="modelModal" class="absolute inset-0 bg-black bg-opacity-90 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white p-4 rounded-xl shadow-2xl w-full max-w-md relative">
            <button id="closeModelButton" class="absolute top-2 right-2 text-gray-500 hover:text-red-500 text-2xl font-bold z-10 p-2">&times;</button>
            <h3 class="text-xl font-bold text-gray-800 mb-4 text-center">Ù…Ø¯Ù„ Ø´Ù…Ø§ØªÛŒÚ© Ú¯Ø§Ø² Ù‡ÙˆØ´Ù…Ù†Ø¯</h3>
            
            <model-viewer 
                src="./SSO.glb"
                alt="Ù…Ø¯Ù„ Ø³Ù‡ Ø¨Ø¹Ø¯ÛŒ Ú¯Ø§Ø² Ù‡ÙˆØ´Ù…Ù†Ø¯"
                auto-rotate
                camera-controls
                ar
                shadow-intensity="1">
            </model-viewer>
            
            <p class="text-center text-sm text-gray-500 mt-4">Ø¨Ø±Ø§ÛŒ Ú†Ø±Ø®Ø´ Ù…Ø¯Ù„ Ø§Ù†Ú¯Ø´Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ú©Ø´ÛŒØ¯</p>
        </div>
    </div>

    <!-- Ù…ÙˆØ¯Ø§Ù„ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆØ§ÛŒâ€ŒÙØ§ÛŒ -->
    <div id="setupModal" class="absolute inset-0 bg-gray-900 bg-opacity-95 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 class="text-2xl font-bold text-blue-600 mb-6 text-center">ØªÙ†Ø¸ÛŒÙ…Ø§Øª Wi-Fi Ø§Ø² Ø·Ø±ÛŒÙ‚ Ø¨Ù„ÙˆØªÙˆØ«</h2>
            <p id="bleStatus" class="text-sm text-gray-600 mb-4 text-center">Ù„Ø·ÙØ§Ù‹ Ø¨Ø±Ø¯ ESP32 Ø±Ø§ Ø¯Ø± Ø­Ø§Ù„Øª ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯.</p>

            <label for="ssidInput" class="block text-sm font-medium text-gray-700 mt-4 mb-1">Ù†Ø§Ù… Ø´Ø¨Ú©Ù‡ (SSID)</label>
            <input type="text" id="ssidInput" placeholder="Ù†Ø§Ù… ÙˆØ§ÛŒâ€ŒÙØ§ÛŒ" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none mb-4">

            <label for="passwordInput" class="block text-sm font-medium text-gray-700 mb-1">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± (Password)</label>
            <input type="password" id="passwordInput" placeholder="Ø±Ù…Ø² ÙˆØ§ÛŒâ€ŒÙØ§ÛŒ" class="w-full border-2 border-gray-300 rounded-lg p-3 outline-none mb-6">

            <button id="connectButton" disabled class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg transition duration-200 shadow-md disabled:opacity-50">
                Ø§ØªØµØ§Ù„ Ùˆ Ø§Ø±Ø³Ø§Ù„ ØªÙ†Ø¸ÛŒÙ…Ø§Øª
            </button>
            
            <button id="backToLogin" class="w-full mt-3 text-gray-600 hover:text-gray-800 py-2 rounded-lg transition duration-150">
                Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯
            </button>
        </div>
    </div>

    <!-- ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ Ú©Ù†ØªØ±Ù„ -->
    <div id="app" class="w-full max-w-sm p-6 bg-white rounded-xl shadow-2xl text-center flex flex-col items-center hidden overflow-y-auto max-h-screen">
        <!-- Ø³Ø§Ø¹Øª Ø²Ù†Ø¯Ù‡ Ø§ÛŒØ±Ø§Ù† -->
        <div id="iranClock" class="text-sm text-gray-500 mb-3 hidden">--:--:--</div>

        <h1 class="text-2xl font-bold text-gray-800 mb-6">Ú©Ù†ØªØ±Ù„ Ú¯Ø§Ø²</h1>

        <div id="statusDisplay" class="text-xl font-semibold p-3 w-full rounded-lg mb-6 transition-colors duration-500">
            Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...
        </div>

        <button id="toggleButton" disabled class="toggle-button text-white font-bold py-3 px-6 rounded-full opacity-50 w-full mb-6">
            ...
        </button>

        <!-- Ø¨Ø®Ø´ Ú©Ù†ØªØ±Ù„ Ø´Ø¯Øª Ú¯Ø§Ø² -->
        <div id="gasControlContainer" class="w-full border-t pt-6 mt-2 hidden">
            <div class="flex justify-between items-center mb-4">
                <span class="text-gray-700 font-medium">Ù…ÛŒØ²Ø§Ù† Ø¨Ø§Ø² Ø¨ÙˆØ¯Ù† Ú¯Ø§Ø²:</span>
                <span id="gasPercentageLabel" class="text-indigo-600 font-bold text-lg">50%</span>
            </div>
            <input 
                type="range" 
                id="gasSlider" 
                min="0" 
                max="100" 
                value="50" 
                class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-indigo-600"
            />
            <div class="flex justify-between text-xs text-gray-400 mt-2">
                <span>100%</span>
                <span id="gasDegreeLabel">90 Ø¯Ø±Ø¬Ù‡</span>
                <span>0%</span>
            </div>

            <!-- Ø¨Ø®Ø´ Ø¯Ù…Ø§ (Ø²ÛŒØ± Ø§Ø³Ù„Ø§ÛŒØ¯Ø± Ú¯Ø§Ø²) -->
            <div class="mt-4 text-left w-full">
                <div id="tempContainer" class="p-3 bg-gray-50 rounded-lg text-right">
                    <div class="text-gray-700">Ø¯Ù…Ø§: <span id="temperatureValue" class="font-bold text-indigo-600">-- Â°C</span></div>
                    <div class="text-xs text-gray-400 mt-1">Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: <span id="tempUpdatedAt">--</span></div>
                </div>
            </div>
        </div>

        <!-- Ø¨Ø®Ø´ Ø¬Ø¯ÛŒØ¯: Ú©Ù†ØªØ±Ù„ Ù‡Ù…Ø²Ù† -->
        <div id="mixerSection" class="w-full border-t pt-6 mt-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Ú©Ù†ØªØ±Ù„ Ù‡Ù…Ø²Ù†</h2>
            
            <button id="mixerToggleButton" disabled class="toggle-button text-white font-bold py-3 px-6 rounded-full w-full mb-4 shadow-md opacity-50">
                Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ...
            </button>

            <!-- Ø§ÛŒÙ† Ø¨Ø®Ø´ ÙˆÙ‚ØªÛŒ Ù‡Ù…Ø²Ù† Ø®Ø§Ù…ÙˆØ´Ù‡ Ù…Ø®ÙÛŒ Ù…ÛŒØ´Ù‡ -->
            <div id="mixerSliderContainer" class="w-full hidden transition-all duration-300">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-gray-700 font-medium">Ù‚Ø¯Ø±Øª Ù‡Ù…Ø²Ù†:</span>
                    <span id="mixerPowerLabel" class="text-blue-600 font-bold text-lg">0%</span>
                </div>
                
                <input 
                    type="range" 
                    id="mixerPowerSlider" 
                    min="0" 
                    max="100" 
                    value="0" 
                    class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                />
                <!-- Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² dir=ltr Ø§Ø¹Ø¯Ø§Ø¯ ØµÙØ± Ùˆ ØµØ¯ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ø²ÛŒØ± Ø¯Ùˆ Ø³Ø± Ø§Ø³Ù„Ø§ÛŒØ¯Ø± ØªÙ†Ø¸ÛŒÙ… Ù…ÛŒâ€ŒØ´Ù† -->
                <div dir="ltr" class="flex justify-between text-xs text-gray-500 mt-2 px-1 font-semibold">
                    <span>0%</span>
                    <span>100%</span>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
        // ØªÙˆØ¬Ù‡: ÙØ§ÛŒÙ„ config.js Ø¨Ø§ÛŒØ¯ Ø¯Ø± Ù…Ø³ÛŒØ± ØµØ­ÛŒØ­ Ú©Ù†Ø§Ø± Ø§ÛŒÙ† ÙØ§ÛŒÙ„ Ø¨Ø§Ø´Ù‡
        import { supabaseUrl, supabaseAnonKey, ESP_NAME, WIFI_PROV_SERVICE_UUID, SSID_CHARACTERISTIC_UUID, PASS_CHARACTERISTIC_UUID } from './config.js';

        const TABLE_NAME = 'toggle_status';
        const STATUS_ROW_ID = 1; 
        const SECRETS_TABLE_NAME = 'app_config';
        const SECRETS_ROW_ID = 1;
        
        const SERVO_TABLE_NAME = 'servo';
        const SERVO_ROW_ID = 1;

        const TEMP_TABLE_NAME = 'tempera';
        const TEMP_ROW_ID = 1;

        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª ØªÛŒØ¨Ù„ Ù‡Ù…Ø²Ù†
        const MIXER_TABLE_NAME = 'mixer';
        const MIXER_ROW_ID = 1;

        const app = document.getElementById('app');
        const loginScreen = document.getElementById('loginScreen');
        const setupModal = document.getElementById('setupModal');
        const modelModal = document.getElementById('modelModal'); 
        
        const pinInput = document.getElementById('pinInput');
        const pinSubmitButton = document.getElementById('pinSubmitButton');
        const pinError = document.getElementById('pinError');
        const pinLoadingStatus = document.getElementById('pinLoadingStatus');
        const statusDisplay = document.getElementById('statusDisplay');
        const toggleButton = document.getElementById('toggleButton');
        const setupButton = document.getElementById('setupButton');
        const show3dButton = document.getElementById('show3dButton');
        const closeModelButton = document.getElementById('closeModelButton');
        const backToLogin = document.getElementById('backToLogin');
        const ssidInput = document.getElementById('ssidInput');
        const passwordInput = document.getElementById('passwordInput');
        const connectButton = document.getElementById('connectButton');
        const bleStatus = document.getElementById('bleStatus');

        const gasControlContainer = document.getElementById('gasControlContainer');
        const gasSlider = document.getElementById('gasSlider');
        const gasPercentageLabel = document.getElementById('gasPercentageLabel');
        const gasDegreeLabel = document.getElementById('gasDegreeLabel');

        const iranClock = document.getElementById('iranClock');
        const temperatureValue = document.getElementById('temperatureValue');
        const tempUpdatedAt = document.getElementById('tempUpdatedAt');

        // Ø§Ù„Ù…Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ù‡Ù…Ø²Ù†
        const mixerToggleButton = document.getElementById('mixerToggleButton');
        const mixerSliderContainer = document.getElementById('mixerSliderContainer');
        const mixerPowerSlider = document.getElementById('mixerPowerSlider');
        const mixerPowerLabel = document.getElementById('mixerPowerLabel');

        let supabase;
        let secretPin = null;
        let iranClockInterval = null;

        // ------ Ø¨Ø®Ø´ Ù…Ù†Ø·Ù‚ Ú¯Ø§Ø² Ùˆ Ø³ÙˆØ¦ÛŒÚ† Ø§ØµÙ„ÛŒ ------
        const updateUI = (isActive) => {
            const buttonState = {
                true: { text: "Ø®Ø§Ù…ÙˆØ´ Ú©Ù†", classes: 'bg-red-600 hover:bg-red-700' },
                false: { text: "Ø±ÙˆØ´Ù† Ú©Ù†", classes: 'bg-green-600 hover:bg-green-700' },
                null: { text: "Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯", classes: 'bg-gray-400 opacity-50', disabled: true }
            };

            const displayState = {
                true: { text: "ÙˆØ¶Ø¹ÛŒØª: Ø±ÙˆØ´Ù†", classes: 'bg-green-100 text-green-700 ring-4 ring-green-300' },
                false: { text: "ÙˆØ¶Ø¹ÛŒØª: Ø®Ø§Ù…ÙˆØ´", classes: 'bg-red-100 text-red-700 ring-4 ring-red-300' },
                null: { text: "Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...", classes: 'bg-gray-100 text-gray-500' }
            };

            const state = isActive === true ? 'true' : (isActive === false ? 'false' : 'null');

            statusDisplay.textContent = displayState[state].text;
            statusDisplay.className = `text-xl font-semibold p-3 w-full rounded-lg mb-6 transition-colors duration-500 ${displayState[state].classes}`;
            
            toggleButton.textContent = buttonState[state].text;
            toggleButton.className = `toggle-button text-white font-bold py-3 px-6 rounded-full w-full mb-6 ${buttonState[state].classes}`;
            toggleButton.disabled = buttonState[state].disabled || false;
            
            if (isActive === true) {
                gasControlContainer.classList.remove('hidden');
            } else {
                gasControlContainer.classList.add('hidden');
            }

            if (isActive !== null) {
                toggleButton.dataset.isActive = isActive;
            }
        };

        async function updateServoAngle(percentage) {
            const degree = Math.round((percentage * 180) / 100);
            gasPercentageLabel.textContent = `${percentage}%`;
            gasDegreeLabel.textContent = `${degree} Ø¯Ø±Ø¬Ù‡`;

            try {
                const { error } = await supabase
                    .from(SERVO_TABLE_NAME)
                    .update({ ang: degree })
                    .eq('id', SERVO_ROW_ID);

                if (error) throw error;
            } catch (error) {
                console.error("Error updating servo angle:", error);
            }
        }

        // ------ Ø¨Ø®Ø´ Ø¬Ø¯ÛŒØ¯: Ù…Ù†Ø·Ù‚ Ù‡Ù…Ø²Ù† ------
        const updateMixerUI = (isOn, power) => {
            if (isOn === null) return; // Ø¯ÛŒØªØ§ÛŒÛŒ Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯Ù‡

            mixerToggleButton.disabled = false;
            mixerToggleButton.classList.remove('opacity-50', 'bg-gray-400');

            if (isOn) {
                // Ø§Ú¯Ø± Ø±ÙˆØ´Ù†Ù‡ØŒ Ø¯Ú©Ù…Ù‡ Ù‚Ø±Ù…Ø² Ø¨Ø±Ø§ÛŒ Ø®Ø§Ù…ÙˆØ´ Ú©Ø±Ø¯Ù† Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø¨Ø´Ù‡
                mixerToggleButton.textContent = "Ø®Ø§Ù…ÙˆØ´ Ú©Ù†";
                mixerToggleButton.className = "toggle-button text-white font-bold py-3 px-6 rounded-full w-full mb-4 shadow-md bg-red-500 hover:bg-red-600";
                mixerSliderContainer.classList.remove('hidden');
            } else {
                // Ø§Ú¯Ø± Ø®Ø§Ù…ÙˆØ´Ù‡ØŒ Ø¯Ú©Ù…Ù‡ Ø³Ø¨Ø² Ø¨Ø±Ø§ÛŒ Ø±ÙˆØ´Ù† Ú©Ø±Ø¯Ù† Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø¨Ø´Ù‡
                mixerToggleButton.textContent = "Ø±ÙˆØ´Ù† Ú©Ù†";
                mixerToggleButton.className = "toggle-button text-white font-bold py-3 px-6 rounded-full w-full mb-4 shadow-md bg-green-500 hover:bg-green-600";
                mixerSliderContainer.classList.add('hidden');
            }

            if (power !== undefined && power !== null) {
                mixerPowerSlider.value = power;
                mixerPowerLabel.textContent = `${power}%`;
            }

            mixerToggleButton.dataset.isOn = isOn;
        };

        async function fetchMixerStatus() {
            try {
                const { data, error } = await supabase
                    .from(MIXER_TABLE_NAME)
                    .select('is_on, power')
                    .eq('id', MIXER_ROW_ID)
                    .maybeSingle();

                if (error) throw error;

                if (!data) {
                    console.log("Mixer row not found. Inserting default.");
                    const { error: insertError } = await supabase.from(MIXER_TABLE_NAME).insert({ id: MIXER_ROW_ID, is_on: false, power: 0 });
                    if (insertError) throw insertError;
                    updateMixerUI(false, 0);
                } else {
                    updateMixerUI(data.is_on, data.power);
                }
            } catch (error) {
                console.error("Error fetching mixer status:", error);
                mixerToggleButton.textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ù‡Ù…Ø²Ù†";
            }
        }

        async function toggleMixerStatus() {
            const currentStatus = mixerToggleButton.dataset.isOn === 'true';
            const newStatus = !currentStatus;

            mixerToggleButton.disabled = true;
            mixerToggleButton.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...";

            try {
                const { error } = await supabase
                    .from(MIXER_TABLE_NAME)
                    .update({ is_on: newStatus })
                    .eq('id', MIXER_ROW_ID);

                if (error) throw error;
                // ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª UI Ø¨Ù‡ ØµÙˆØ±Øª Ø§ØªÙˆÙ…Ø§ØªÛŒÚ© Ø§Ø² Ø·Ø±ÛŒÙ‚ Realtime Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´Ù‡
            } catch (error) {
                console.error("Error toggling mixer:", error);
                mixerToggleButton.disabled = false;
                mixerToggleButton.textContent = "Ø®Ø·Ø§! Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯";
            }
        }

        async function updateMixerPower(value) {
            mixerPowerLabel.textContent = `${value}%`;
            try {
                const { error } = await supabase
                    .from(MIXER_TABLE_NAME)
                    .update({ power: parseInt(value) })
                    .eq('id', MIXER_ROW_ID);

                if (error) throw error;
            } catch (error) {
                console.error("Error updating mixer power:", error);
            }
        }

        function setupMixerRealtimeListener() {
            supabase.channel('mixer_channel')
                .on('postgres_changes', { 
                    event: 'UPDATE', 
                    schema: 'public', 
                    table: MIXER_TABLE_NAME,
                    filter: `id=eq.${MIXER_ROW_ID}` 
                }, (payload) => {
                    if (payload && payload.new) {
                        updateMixerUI(payload.new.is_on, payload.new.power);
                    }
                })
                .subscribe();
        }

        // ------ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ù„ÙˆØªÙˆØ« Ùˆ ÙˆØ§ÛŒâ€ŒÙØ§ÛŒ ------
        async function connectAndSendCredentials() {
            if (!navigator.bluetooth) {
                bleStatus.textContent = "âŒ Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Web Bluetooth Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.";
                connectButton.disabled = true;
                return;
            }

            const ssid = ssidInput.value.trim();
            const password = passwordInput.value;

            if (ssid.length < 1) {
                bleStatus.textContent = "Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ø´Ø¨Ú©Ù‡ (SSID) Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.";
                return;
            }

            bleStatus.textContent = "ğŸ” Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø¨Ø±Ø¯ ESP32...";
            connectButton.disabled = true;

            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: ESP_NAME }],
                    optionalServices: [WIFI_PROV_SERVICE_UUID]
                });
                
                bleStatus.textContent = `âœ… Ø¯Ø³ØªÚ¯Ø§Ù‡ ${device.name} Ù¾ÛŒØ¯Ø§ Ø´Ø¯. Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...`;

                const server = await device.gatt.connect();
                bleStatus.textContent = "ğŸ”— Ù…ØªØµÙ„ Ø´Ø¯. Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø³Ø±ÙˆÛŒØ³...";

                const service = await server.getPrimaryService(WIFI_PROV_SERVICE_UUID);
                bleStatus.textContent = "ğŸ“¡ Ø³Ø±ÙˆÛŒØ³ Wi-Fi Provisioning Ù¾ÛŒØ¯Ø§ Ø´Ø¯. Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø§Ø¯Ù‡...";

                const ssidCharacteristic = await service.getCharacteristic(SSID_CHARACTERISTIC_UUID);
                const passCharacteristic = await service.getCharacteristic(PASS_CHARACTERISTIC_UUID);

                await ssidCharacteristic.writeValue(new TextEncoder().encode(ssid));
                bleStatus.textContent = `ğŸ”‘ SSID (${ssid}) Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯. Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ø±Ù…Ø²...`;
                
                await passCharacteristic.writeValue(new TextEncoder().encode(password));
                bleStatus.textContent = "âœ… Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯! ESP32 Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„ Ø¨Ù‡ ÙˆØ§ÛŒâ€ŒÙØ§ÛŒ Ø§Ø³Øª.";

                server.disconnect();

                setTimeout(() => {
                    setupModal.classList.add('hidden');
                    loginScreen.classList.remove('hidden');
                    bleStatus.textContent = "Ù„Ø·ÙØ§Ù‹ Ø¨Ø±Ø¯ ESP32 Ø±Ø§ Ø¯Ø± Ø­Ø§Ù„Øª ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯.";
                    connectButton.disabled = false;
                }, 2000);

            } catch (error) {
                console.error("Bluetooth Error:", error);
                if (error && error.message && error.message.includes("cancelled")) {
                      bleStatus.textContent = "Ø¹Ù…Ù„ÛŒØ§Øª ØªÙˆØ³Ø· Ú©Ø§Ø±Ø¨Ø± Ù„ØºÙˆ Ø´Ø¯.";
                } else {
                    bleStatus.textContent = `âŒ Ø®Ø·Ø§ÛŒ Ø§ØªØµØ§Ù„ Ø¨Ù„ÙˆØªÙˆØ«: ${error?.message || error}`;
                }
                connectButton.disabled = false;
            }
        }

        // ------ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù„ÛŒØ¯ Ùˆ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ------
        async function fetchSecretPin() {
            pinLoadingStatus.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù„ÛŒØ¯ Ø§Ù…Ù†ÛŒØªÛŒ...";
            try {
                const { data, error } = await supabase
                    .from(SECRETS_TABLE_NAME)
                    .select('pin_code')
                    .eq('id', SECRETS_ROW_ID)
                    .single();

                if (error || !data || !data.pin_code) throw new Error("PIN not found or RLS error.");

                secretPin = data.pin_code;
                pinLoadingStatus.textContent = "Ú©Ø¯ Ø§Ù…Ù†ÛŒØªÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:";

                pinInput.disabled = false;
                pinInput.classList.remove('opacity-50');
                pinSubmitButton.disabled = false;
                pinSubmitButton.className = 'w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition duration-200 shadow-md hover:shadow-lg';

                setupButton.disabled = false; 
                show3dButton.disabled = false;
            } catch (error) {
                console.error("Error fetching PIN:", error);
                pinLoadingStatus.textContent = "âŒ Ø®Ø·Ø§: Ú©Ù„ÛŒØ¯ Ø§Ù…Ù†ÛŒØªÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ø´Ø¯.";
                pinSubmitButton.disabled = true;
                setupButton.disabled = false; 
                show3dButton.disabled = false;
            }
        }

        async function fetchInitialStatus() {
            updateUI(null);

            const { data, error } = await supabase
                .from(TABLE_NAME)
                .select('is_active')
                .eq('id', STATUS_ROW_ID)
                .maybeSingle();

            if (error) {
                console.error("Error fetching status:", error);
                statusDisplay.textContent = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¶Ø¹ÛŒØª Ø§ÙˆÙ„ÛŒÙ‡.";
                updateUI(null);
                return;
            }

            if (!data) {
                const { error: insertError } = await supabase.from(TABLE_NAME).insert({ id: STATUS_ROW_ID, is_active: true });
                if (insertError) {
                    console.error("Error inserting initial status:", insertError);
                    statusDisplay.textContent = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ ÙˆØ¶Ø¹ÛŒØª Ø§ÙˆÙ„ÛŒÙ‡.";
                    updateUI(null);
                    return;
                }
                updateUI(true);
            } else {
                updateUI(data.is_active);
            }

            // Ø¯Ø±ÛŒØ§ÙØª Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡ Ø³Ø±ÙˆÙˆ Ú¯Ø§Ø²
            const { data: servoData } = await supabase
                .from(SERVO_TABLE_NAME)
                .select('ang')
                .eq('id', SERVO_ROW_ID)
                .maybeSingle();
            
            if (servoData) {
                const initialPercent = Math.round((servoData.ang / 180) * 100);
                gasSlider.value = initialPercent;
                gasPercentageLabel.textContent = `${initialPercent}%`;
                gasDegreeLabel.textContent = `${servoData.ang} Ø¯Ø±Ø¬Ù‡`;
            }
        }

        function setupRealtimeListener() {
            supabase.channel('status_channel')
                .on('postgres_changes', { 
                    event: 'UPDATE', 
                    schema: 'public', 
                    table: TABLE_NAME,
                    filter: `id=eq.${STATUS_ROW_ID}` 
                }, (payload) => {
                    updateUI(payload.new.is_active);
                })
                .subscribe((status) => {
                    if (status !== 'SUBSCRIBED') {
                        if (status === 'CHANNEL_ERROR') {
                            statusDisplay.textContent = "âš ï¸ Ø§Ø®Ø·Ø§Ø±: Ø®Ø·Ø§ÛŒ Realtime.";
                        }
                    }
                });
        }

        // Realtime listener Ø¨Ø±Ø§ÛŒ Ø¯Ù…Ø§
        function setupTemperatureListener() {
            supabase.channel('temperature_channel')
                .on('postgres_changes', {
                    event: 'UPDATE',
                    schema: 'public',
                    table: TEMP_TABLE_NAME,
                    filter: `id=eq.${TEMP_ROW_ID}`
                }, (payload) => {
                    if (payload && payload.new) {
                        updateTemperatureUI(payload.new.temperature, payload.new.updated_at);
                    }
                })
                .subscribe();
        }

        function updateTemperatureUI(temp, updated_at) {
            try {
                const v = (typeof temp === 'number') ? temp.toFixed(2) : temp;
                temperatureValue.textContent = `${v} Â°C`;
                const d = new Date(updated_at);
                const fmt = new Intl.DateTimeFormat('fa-IR', {
                    timeZone: 'Asia/Tehran',
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
                });
                tempUpdatedAt.textContent = fmt.format(d);
            } catch (err) {
                console.error('Error formatting temperature UI:', err);
            }
        }

        async function fetchTemperature() {
            try {
                const { data, error } = await supabase
                    .from(TEMP_TABLE_NAME)
                    .select('temperature, updated_at')
                    .eq('id', TEMP_ROW_ID)
                    .maybeSingle();

                if (error) return console.error('Error fetching temperature:', error);
                
                if (data) {
                    updateTemperatureUI(data.temperature, data.updated_at);
                } else {
                    temperatureValue.textContent = `-- Â°C`;
                    tempUpdatedAt.textContent = `--`;
                }
            } catch (err) {
                console.error('fetchTemperature error:', err);
            }
        }

        async function toggleStatus() {
            const currentStatus = toggleButton.dataset.isActive === 'true';
            const newStatus = !currentStatus;

            toggleButton.disabled = true;
            toggleButton.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡...";
            statusDisplay.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ ØªØºÛŒÛŒØ± Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³...";

            try {
                const { error } = await supabase
                    .from(TABLE_NAME)
                    .update({ is_active: newStatus })
                    .eq('id', STATUS_ROW_ID);

                if (error) throw error;
                updateUI(newStatus);
            } catch (error) {
                console.error("Error toggling status:", error);
                statusDisplay.textContent = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ ÙˆØ¶Ø¹ÛŒØª.";
                fetchInitialStatus();
            } finally {
                toggleButton.disabled = false;
            }
        }

        function checkPIN() {
            pinError.classList.add('hidden');

            if (pinInput.value === secretPin) { 
                loginScreen.classList.add('hidden');
                app.classList.remove('hidden'); 

                // ÙØ±Ø§Ø®ÙˆØ§Ù†ÛŒ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ Ø¨Ø¹Ø¯ Ø§Ø² Ù„Ø§Ú¯ÛŒÙ† Ù…ÙˆÙÙ‚
                fetchInitialStatus();
                setupRealtimeListener();

                fetchMixerStatus();
                setupMixerRealtimeListener();

                startIranClock();

                fetchTemperature();
                setupTemperatureListener();
            } else {
                pinError.classList.remove('hidden');
                pinInput.value = ''; 
            }
        }

        function startIranClock() {
            if (iranClockInterval) clearInterval(iranClockInterval);

            function updateClock() {
                const now = new Date();
                const fmt = new Intl.DateTimeFormat('fa-IR', {
                    timeZone: 'Asia/Tehran',
                    hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
                });
                iranClock.textContent = fmt.format(now);
                iranClock.classList.remove('hidden');
            }

            updateClock();
            iranClockInterval = setInterval(updateClock, 1000);
        }

        function initializeApp() {
            try {
                supabase = createClient(supabaseUrl, supabaseAnonKey);
            } catch (error) {
                console.error("Supabase Client Initialization Error:", error);
                pinLoadingStatus.textContent = "âŒ Ø®Ø·Ø§ÛŒ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø³ÙˆÙ¾Ø§Ø¨ÛŒØ³.";
            }

            pinSubmitButton.addEventListener('click', checkPIN);
            pinInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') checkPIN();
            });
            toggleButton.addEventListener('click', toggleStatus);

            // Ø±ÙˆÛŒØ¯Ø§Ø¯ ØªØºÛŒÛŒØ± Ø§Ø³Ù„Ø§ÛŒØ¯Ø± Ú¯Ø§Ø²
            gasSlider.addEventListener('input', (e) => {
                updateServoAngle(e.target.value);
            });

            // Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ù‡Ù…Ø²Ù†
            mixerToggleButton.addEventListener('click', toggleMixerStatus);
            
            // Ù…ÙˆÙ‚Ø¹ Ú©Ø´ÛŒØ¯Ù† Ø§Ø³Ù„Ø§ÛŒØ¯Ø± ÙÙ‚Ø· Ø¹Ø¯Ø¯ Ø±Ùˆ Ù†Ø´ÙˆÙ† Ù…ÛŒØ¯Ù‡ Ú©Ù‡ Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ ÙØ´Ø§Ø± Ù†ÛŒØ§Ø¯
            mixerPowerSlider.addEventListener('input', (e) => {
                mixerPowerLabel.textContent = `${e.target.value}%`;
            });
            // ÙˆÙ‚ØªÛŒ Ø¯Ø³ØªØª Ø±Ùˆ Ø§Ø² Ø±ÙˆÛŒ Ø§Ø³Ù„Ø§ÛŒØ¯Ø± Ø¨Ø±Ø¯Ø§Ø´ØªÛŒ (change) Ø¯ÛŒØªØ§ Ø³Ù…Øª Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø¢Ù¾Ø¯ÛŒØª Ù…ÛŒâ€ŒØ´Ù‡
            mixerPowerSlider.addEventListener('change', (e) => {
                updateMixerPower(e.target.value);
            });

            // Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ù…ÙˆØ¯Ø§Ù„â€ŒÙ‡Ø§
            setupButton.addEventListener('click', () => {
                loginScreen.classList.add('hidden');
                setupModal.classList.remove('hidden');
                ssidInput.focus();
            });

            backToLogin.addEventListener('click', () => {
                setupModal.classList.add('hidden');
                loginScreen.classList.remove('hidden');
            });
            
            show3dButton.addEventListener('click', () => {
                modelModal.classList.remove('hidden');
            });

            closeModelButton.addEventListener('click', () => {
                modelModal.classList.add('hidden');
            });

            modelModal.addEventListener('click', (e) => {
                if (e.target === modelModal) {
                    modelModal.classList.add('hidden');
                }
            });
            
            connectButton.addEventListener('click', connectAndSendCredentials);
            
            ssidInput.addEventListener('input', () => {
                connectButton.disabled = ssidInput.value.trim().length < 1;
            });

            fetchSecretPin();
        }

        window.onload = initializeApp;

    </script>
</body>
</html>
