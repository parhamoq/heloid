<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>سایت تکالیف دوره سی</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Favicon -->
  <link rel="icon" href="icon.png" type="image/png">
  <!-- Vazirmatn Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700;900&display=swap" rel="stylesheet">
  <style>
    /* CSS Styles remain the same */
    :root {
      --neon-yellow: #FFD525;
      --neon-green: #39ff14;
      --neon-orange: #ff9900;
      --neon-cyan: #00e5ff;
      --neon-red: #ff4d4d;
      --glass-blur: 8px;
    }
    body[data-theme='dark'] {
      --bg-gradient: linear-gradient(180deg, #041223 0%, #071a38 55%, #05203a 100%);
      background-attachment: fixed;
      background-repeat: no-repeat;
      --surface: rgba(10, 16, 25, 0.7);
      --muted: #9aa4b2;
      --text: #e6eef8;
      --card: rgba(255, 255, 255, 0.02);
      --border-color: rgba(255, 255, 255, 0.08);
      --particle: rgba(255, 255, 255, 0.06);
      --block-bg: #161b22; 
      color-scheme: dark;
    }
    body[data-theme='light'] {
      --bg-gradient: linear-gradient(180deg, #f7f9fb, #eef2f6);
      --surface: rgba(255, 255, 255, 0.8);
      --muted: #556074;
      --text: #0f1720;
      --card: rgba(2, 6, 23, 0.02);
      --border-color: rgba(2, 6, 23, 0.1);
      --particle: rgba(10, 20, 30, 0.06);
      --block-bg: #ffffff;
      color-scheme: light;
    }
    html, body { height: 100%; }
    body {
      font-family: 'Vazirmatn', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      background: var(--bg-gradient);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      transition: background 240ms ease, color 240ms ease;
      /*overflow: hidden; /* Disable main scroll */
      /*zoom: .925; /* Apply 80% zoom */
    }
    @media (min-width: 1024px) {
        body {
            overflow: hidden; /* اسکرول غیرفعال برای لپ‌تاپ و بالاتر */
        }
    }
    @media (max-width: 1023px) {
        body {
            overflow: auto; /* اسکرول فعال برای موبایل و تبلت */
        }
    }
    .bg-ambient { position: fixed; inset: 0; pointer-events: none; z-index: 0; mix-blend-mode: overlay; }
    .site-header {
      backdrop-filter: blur(var(--glass-blur));
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid var(--border-color);
    }
    body[data-theme='light'] .site-header { background: rgba(255, 255, 255, 0.7); }
    .class-block {
      border-radius: 1.5rem;
      border: 1px solid var(--border-color);
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
      padding: 2rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      transition: transform 320ms cubic-bezier(.2, .9, .2, 1), box-shadow 320ms ease, border-color 220ms ease;
      cursor: pointer;
      user-select: none;
      position: relative;
      overflow: hidden;
      box-shadow: 0 0 25px 4px rgba(var(--glow-rgb), 0.35);
    }
    body[data-theme='light'] .class-block {
      background: linear-gradient(180deg, #fff, #fbfdff);
      box-shadow: 0 0 25px 4px rgba(var(--glow-rgb), 0.25);
    }
    .class-block:focus { outline: 3px solid rgba(0, 0, 0, 0.06); outline-offset: 3px; }
    .class-block:hover {
      transform: translateY(-10px) scale(1.03);
      box-shadow: 0 0 40px 10px rgba(var(--glow-rgb), 0.55);
    }
    body[data-theme='light'] .class-block:hover { box-shadow: 0 0 40px 10px rgba(var(--glow-rgb), 0.45); }
    .neon-label {
      font-weight: 900;
      font-size: clamp(2rem, 8vw, 3.5rem);
      letter-spacing: 0.01em;
      transition: transform 0.4s ease;
    }
    .modal-overlay {
        position: fixed; inset: 0; display: flex; align-items: center; justify-content: center;
        padding: 1.25rem; z-index: 60;
        background-color: rgba(0, 0, 0, 0.7); 
        backdrop-filter: blur(5px);
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .modal-overlay.visible { opacity: 1; visibility: visible; }
    .modal-card {
        width: 100%; max-width: 420px; border-radius: 12px; padding: 2rem;
        background-color: var(--block-bg);
        box-shadow: 0 25px 50px -12px rgba(0,0,0,0.35);
        border: 1px solid var(--border-color);
        transform: scale(0.95);
        transition: transform 0.3s ease;
    }
    .modal-overlay.visible .modal-card { transform: scale(1); }
    .modal-card input, .modal-card select, .modal-card textarea {
        background-color: rgba(0,0,0,0.2);
        border-color: var(--border-color) !important;
    }
    body[data-theme='light'] .modal-card input, 
    body[data-theme='light'] .modal-card select, 
    body[data-theme='light'] .modal-card textarea { background-color: rgba(0,0,0,0.05); }
    .clone-full {
      position: fixed; display: flex;
      flex-direction: column; /* Changed for homework layout */
      align-items: center; justify-content: flex-start; /* Changed */
      padding: 2rem; z-index: 80;
      overflow-y: auto; /* Allow scrolling for homework */
    }
    .clone-full .neon-label { transform: scale(1.5); }
    .clone-full-content {
      transition: opacity 0.3s ease 0.2s;
      text-align: right; /* Changed for homework */
      width: 100%;
      max-width: 800px;
      margin-top: 15vh; /* Push content down */
    }
    .content-hidden { opacity: 0; pointer-events: none; transition: opacity 0.4s ease; }
    #particle-container { position: fixed; inset: 0; pointer-events: none; z-index: 0; }
    .particle {
      position: absolute; border-radius: 999px; background: var(--particle);
      opacity: 0; animation: floatUp linear infinite;
    }
    @keyframes floatUp {
      0% { transform: translateY(10vh) scale(0.85); opacity: 0; }
      20% { opacity: 0.6; }
      100% { transform: translateY(-120vh) scale(1); opacity: 0; }
    }
    /* NEW: Styles for scrollable announcements */
    #announcements-list {
      max-height: 120px;
      overflow-y: auto;
      padding-left: 1rem; /* Space for scrollbar in RTL */
    }
    #announcements-list::-webkit-scrollbar {
      width: 6px;
    }
    #announcements-list::-webkit-scrollbar-track {
      background: rgba(0,0,0,0.1);
      border-radius: 10px;
    }
    #announcements-list::-webkit-scrollbar-thumb {
      background: var(--muted);
      border-radius: 10px;
    }
    @media (min-width: 750px) { .class-block { min-height: 10rem; } }
  </style>
</head>
<body data-theme="dark">
  <div class="bg-ambient" aria-hidden="true"></div>
  <div id="particle-container" aria-hidden="true"></div>

  <div id="main-content" class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 py-10" style="transition: opacity 0.4s ease;">
    <header class="site-header flex flex-col sm:flex-row items-center justify-between gap-4 mb-8 p-3 rounded-xl">
      <div class="flex items-center gap-4">
        <img src="icon.png" alt="لوگو" class="w-14 h-14 rounded-full object-cover shadow-lg" onerror="this.style.display='none'" />
        <div class="text-right">
          <h1 class="text-2xl md:text-3xl font-extrabold" style="color:var(--text)">به سایت دوره سی خوش آمدید!</h1>
          <p class="text-sm" style="color:var(--muted)">تکالیف تمام کلاس ها اینجا قرار داده میشه</p>
        </div>
      </div>
      <div id="auth-buttons" class="flex items-center gap-3">
        <button id="login-button" class="px-4 py-2 rounded-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white shadow hover:scale-105 transition-transform focus:outline-none focus:ring-4 focus:ring-blue-300" aria-haspopup="dialog">ورود</button>
        <button id="add-homework-main-button" class="hidden px-4 py-2 rounded-full bg-gradient-to-r from-green-500 to-emerald-600 text-white shadow hover:scale-105 transition-transform focus:outline-none focus:ring-4 focus:ring-green-300">افزودن تکلیف</button>
        <button id="logout-button" class="hidden px-4 py-2 rounded-full bg-gradient-to-r from-red-500 to-rose-600 text-white shadow hover:scale-105 transition-transform focus:outline-none focus:ring-4 focus:ring-red-300">خروج</button>
        <button id="theme-toggle" class="p-3 rounded-lg bg-white/5 hover:bg-white/10 transition-colors focus:outline-none focus:ring-2 ring-white/20" aria-label="تغییر تم">
          <!-- icon set by JS -->
        </button>
      </div>
    </header>
    <main>
      <section class="mb-8">
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-6" id="class-grid" aria-live="polite">
          <!-- blocks created by JS -->
        </div>
      </section>

      <!-- NEW: Announcements Section -->
      <section id="announcements-section" class="mt-12">
        <h2 class="text-2xl font-bold mb-4 border-b-2 pb-2" style="border-color: var(--border-color);">اعلانات</h2>
        <div id="announcements-list" class="space-y-3">
          <!-- Announcements will be loaded here by JS -->
        </div>
      </section>
    </main>
  </div>

  <!-- NEW: Credit Text -->
  <!--<div class="fixed bottom-4 left-4 text-xs z-20" style="color: var(--muted);">ساخته شده توسط من</div>-->

  <!-- Modals -->
  <div id="login-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="login-title">
    <div class="modal-card">
      <div class="flex items-start justify-between mb-3">
        <h3 id="login-title" class="text-xl font-bold">ورود به پنل</h3>
        <button id="close-login-modal" class="text-gray-400 hover:text-gray-200 text-2xl" aria-label="بستن">&times;</button>
      </div>
      <div>
        <p id="login-message" class="text-sm mb-3 h-6"></p>
        <label for="name-input" class="block text-sm mb-1">کد نماینده</label>
        <input id="name-input" type="text" class="w-full rounded-md p-3 border focus:ring-2 focus:ring-indigo-300" />
        <button id="submit-login" class="mt-4 w-full py-3 bg-gradient-to-r from-indigo-600 to-blue-500 text-white rounded-md hover:opacity-90 transition-opacity">ورود</button>
      </div>
    </div>
  </div>
  <div id="homework-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="homework-title">
      <div class="modal-card">
          <div class="flex items-start justify-between mb-3">
              <h3 id="homework-title" class="text-xl font-bold">افزودن تکلیف جدید</h3>
              <button id="close-homework-modal" class="text-gray-400 hover:text-gray-200 text-2xl" aria-label="بستن">&times;</button>
          </div>
          <div class="space-y-4">
              <div>
                  <label for="class-select" class="block text-sm mb-1">کلاس</label>
                  <select id="class-select" class="w-full rounded-md p-3 border focus:ring-2 focus:ring-indigo-300">
                      <option value="">انتخاب کنید...</option>
                  </select>
              </div>
              <div>
                  <label for="homework-date" class="block text-sm mb-1">تاریخ</label>
                  <input id="homework-date" type="text" placeholder="مثلا: ۱۴۰۳/۰۶/۰۵" class="w-full rounded-md p-3 border focus:ring-2 focus:ring-indigo-300" />
              </div>
              <div>
                  <label for="homework-details" class="block text-sm mb-1">شرح تکلیف</label>
                  <textarea id="homework-details" rows="4" class="w-full rounded-md p-3 border focus:ring-2 focus:ring-indigo-300"></textarea>
              </div>
              <button id="add-homework-button" class="w-full py-3 bg-gradient-to-r from-green-600 to-emerald-500 text-white rounded-md hover:opacity-90 transition-opacity disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                  افزودن تکلیف
              </button>
          </div>
      </div>
  </div>

  <!-- Import Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <script type="module">
    // ============================================
    // SUPABASE CONFIGURATION
    // ============================================
    const SUPABASE_URL = 'https://pyvwnbpufpalbvvnuwch.supabase.co'; // TODO: Replace with your Supabase URL
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB5dnduYnB1ZnBhbGJ2dm51d2NoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMTQ2NTcsImV4cCI6MjA3MTg5MDY1N30.82zlBtvsazt9lQLLBuNtouPKenZPTrBqXc1tEtECSDY'; // TODO: Replace with your Supabase Anon Key

    // Check if Supabase credentials are provided
    if (!SUPABASE_URL || SUPABASE_URL === 'YOUR_SUPABASE_URL') {
      console.error("خطا: اطلاعات اتصال به Supabase را در کد وارد کنید.");
      // Optionally, disable functionality
      // return; 
    }

    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ============================================
    // DOM Elements
    // ============================================
    const classGrid = document.getElementById('class-grid');
    const particleContainer = document.getElementById('particle-container');
    const themeToggle = document.getElementById('theme-toggle');
    const mainContent = document.getElementById('main-content');
    const loginButton = document.getElementById('login-button');
    const addHomeworkMainButton = document.getElementById('add-homework-main-button');
    const logoutButton = document.getElementById('logout-button');
    const loginModal = document.getElementById('login-modal');
    const closeLogin = document.getElementById('close-login-modal');
    const submitLogin = document.getElementById('submit-login');
    const nameInput = document.getElementById('name-input');
    const loginMessage = document.getElementById('login-message');
    const homeworkModal = document.getElementById('homework-modal');
    const closeHomeworkModal = document.getElementById('close-homework-modal');
    const classSelect = document.getElementById('class-select');
    const homeworkDate = document.getElementById('homework-date');
    const homeworkDetails = document.getElementById('homework-details');
    const addHomeworkButton = document.getElementById('add-homework-button');
    const announcementsList = document.getElementById('announcements-list');

    // ============================================
    // Data & State
    // ============================================
    const classNames = ['9/1', '9/2', '9/3', '9/4', '9/5'];
    const neonColors = [
        { name: 'orange', rgb: '255, 153, 0' },      
        { name: 'green',  rgb: '57, 255, 20' },
        { name: 'purple', rgb: '173, 8, 242' },
        { name: 'cyan',   rgb: '0, 229, 255' },
        { name: 'red',    rgb: '255, 77, 77' }
    ];
    let currentCreator = null;

    const sunIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"/></svg>';
    const moonIcon = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>';

    // ============================================
    // Theme, Blocks, Particles (No major changes)
    // ============================================
    function applyTheme(theme) {
      document.body.dataset.theme = theme;
      themeToggle.innerHTML = theme === 'dark' ? sunIcon : moonIcon;
      localStorage.setItem('theme', theme);
    }
    function createBlocks() {
      classGrid.innerHTML = '';
      const totalItems = classNames.length;
      classNames.forEach((name, i) => {
        const div = document.createElement('button');
        div.className = 'class-block';
        const colorInfo = neonColors[i % neonColors.length];
        div.style.setProperty('--glow-rgb', colorInfo.rgb);
        div.setAttribute('aria-label', `باز کردن کلاس ${name}`);
        div.type = 'button';
        const label = document.createElement('div');
        label.className = 'neon-label';
        label.textContent = name;
        div.appendChild(label);
        if (i < 3) { div.classList.add('md:col-span-2'); } else { div.classList.add('md:col-span-3'); }
        if (totalItems % 2 !== 0 && i === totalItems - 1) { div.classList.add('col-span-2'); }
        div.addEventListener('click', () => openFullscreen(div, name));
        classGrid.appendChild(div);
      });
    }
    function createParticles() {
      particleContainer.innerHTML = '';
      const count = Math.floor(window.innerWidth / 15);
      for (let i = 0; i < count; i++) {
        const p = document.createElement('div');
        p.className = 'particle';
        const size = (Math.random() * 2) + 0.6;
        Object.assign(p.style, { width: `${size}px`, height: `${size}px`, left: `${Math.random() * 100}%`, top: `${Math.random() * 100}%`, animationDuration: (18 + Math.random() * 22) + 's', opacity: 0.05 + Math.random() * 0.25 });
        particleContainer.appendChild(p);
      }
    }

    // ============================================
    // Fullscreen View with Homework Loading
    // ============================================
    let activeClone = null;
    async function openFullscreen(el, name) {
      if (activeClone) return;
      
      mainContent.classList.add('content-hidden');
      const rect = el.getBoundingClientRect();
      const clone = el.cloneNode(true);
      clone.classList.add('clone-full');
      Object.assign(clone.style, { position: 'fixed', top: `${rect.top}px`, left: `${rect.left}px`, width: `${rect.width}px`, height: `${rect.height}px`, margin: '0', transition: 'all 450ms cubic-bezier(0.4, 0, 0.2, 1)', zIndex: 80 });
      const contentDiv = document.createElement('div');
      contentDiv.className = 'clone-full-content';
      contentDiv.style.opacity = '0';
      contentDiv.innerHTML = `<p class="text-center" style="color:var(--muted)">در حال بارگذاری تکالیف...</p>`;
      clone.appendChild(contentDiv);
      document.body.appendChild(clone);
      activeClone = { node: clone, rect };

      requestAnimationFrame(async () => {
        Object.assign(clone.style, { top: '0', left: '0', width: '100vw', height: '100vh', borderRadius: '0' });
        contentDiv.style.opacity = '1';
        try {
            const { data, error } = await db
                .from('homeworks')
                .select('*')
                .eq('classname', name)
                .order('created_at', { ascending: false });

            if (error) throw error;

            let homeworkHTML = `<h2 class="text-3xl font-bold mb-6 text-center">تکالیف کلاس ${name}</h2>`;
            if (!data || data.length === 0) {
                homeworkHTML += `<p class="text-center" style="color:var(--muted)">هنوز تکلیفی برای این کلاس ثبت نشده است.</p>`;
            } else {
                homeworkHTML += '<div class="space-y-4">';
                data.forEach(hw => {
                    homeworkHTML += `
                        <div class="p-4 rounded-lg border" style="background-color: var(--card); border-color: var(--border-color);">
                            <p class="font-bold text-lg">${hw.date}</p>
                            <p class="mt-1 whitespace-pre-wrap">${hw.homework}</p>
                        </div>
                    `;
                });
                homeworkHTML += '</div>';
            }
            contentDiv.innerHTML = homeworkHTML;
        } catch (e) {
            console.error("Error fetching homework: ", e);
            contentDiv.innerHTML = `<p class="text-center text-red-400">خطا در بارگذاری تکالیف.</p>`;
        }
      });
      clone.addEventListener('click', closeFullscreen);
    }

    function closeFullscreen() {
      if (!activeClone) return;
      const { node, rect } = activeClone;
      node.querySelector('.clone-full-content').style.opacity = '0';
      setTimeout(() => {
        Object.assign(node.style, { top: `${rect.top}px`, left: `${rect.left}px`, width: `${rect.width}px`, height: `${rect.height}px`, borderRadius: '1.5rem' });
        mainContent.classList.remove('content-hidden');
      }, 150);
      setTimeout(() => { node.remove(); activeClone = null; }, 600);
    }

    // ============================================
    // Auth & UI Logic
    // ============================================
    function showModal(modalEl) { modalEl.classList.add('visible'); }
    function hideModal(modalEl) { modalEl.classList.remove('visible'); }

    function updateUIForLogin(creatorCode) {
        currentCreator = creatorCode;
        loginButton.classList.add('hidden');
        addHomeworkMainButton.classList.remove('hidden');
        logoutButton.classList.remove('hidden');
    }

    function updateUIForLogout() {
        currentCreator = null;
        loginButton.classList.remove('hidden');
        addHomeworkMainButton.classList.add('hidden');
        logoutButton.classList.add('hidden');
    }

    loginButton.addEventListener('click', () => { showModal(loginModal); nameInput.focus(); });
    addHomeworkMainButton.addEventListener('click', () => {
        if (currentCreator) {
            showModal(homeworkModal);
        } else {
            alert("لطفا ابتدا وارد شوید.");
            showModal(loginModal);
        }
    });

    logoutButton.addEventListener('click', () => {
        sessionStorage.removeItem('currentCreator');
        updateUIForLogout();
    });

    closeLogin.addEventListener('click', () => { hideModal(loginModal); });
    loginModal.addEventListener('click', (e) => { if (e.target === loginModal) hideModal(loginModal); });
    closeHomeworkModal.addEventListener('click', () => { hideModal(homeworkModal); });
    homeworkModal.addEventListener('click', (e) => { if (e.target === homeworkModal) hideModal(homeworkModal); });
    // NEW: Function to save invalid access attempts
    async function logNoAccess(failedCode) {
        try {
            const { error } = await db
                .from('noaccess') // table name in Supabase
                .insert([{ attempted_code: failedCode }]); // field name in your table
            if (error) {
                console.error("Error logging failed access:", error);
            } else {
                console.log("Failed access attempt logged successfully.");
            }
        } catch (e) {
            console.error("Exception while logging failed access:", e);
        }
    }

    submitLogin.addEventListener('click', async () => {
        const code = nameInput.value.trim();
        if (!code) return;

        submitLogin.disabled = true;
        loginMessage.textContent = 'در حال بررسی کد...';
        loginMessage.className = 'text-sm mb-3 h-6 text-yellow-400';

        try {
            const { data, error } = await db
                .from('representatives')
                .select('code')
                .eq('code', code);

            if (error) throw error;

            if (!data || data.length === 0) {
                loginMessage.textContent = 'کد وارد شده اشتباه است.';
                loginMessage.className = 'text-sm mb-3 h-6 text-red-400';
                nameInput.value = '';
                await logNoAccess(code);
            } else {
                loginMessage.textContent = 'ورود موفقیت آمیز بود!';
                loginMessage.className = 'text-sm mb-3 h-6 text-green-400';
                sessionStorage.setItem('currentCreator', code);
                updateUIForLogin(code);
                setTimeout(() => {
                    hideModal(loginModal);
                    showModal(homeworkModal);
                    nameInput.value = '';
                    loginMessage.textContent = '';
                }, 1000);
            }
        } catch (error) {
            console.error("Error verifying representative code: ", error);
            loginMessage.textContent = 'خطا در ارتباط با دیتابیس.';
            loginMessage.className = 'text-sm mb-3 h-6 text-red-400';
            await logNoAccess(code); // ✅ این خط هم باید اینجا باشد
        } finally {
            submitLogin.disabled = false;
        }
    });

    // ============================================
    // Homework Panel Logic
    // ============================================
    function validateHomeworkForm() {
        const isClassSelected = classSelect.value !== '';
        const isDateEntered = homeworkDate.value.trim() !== '';
        const isDetailsEntered = homeworkDetails.value.trim() !== '';
        addHomeworkButton.disabled = !(isClassSelected && isDateEntered && isDetailsEntered);
    }
    [classSelect, homeworkDate, homeworkDetails].forEach(el => {
        el.addEventListener('input', validateHomeworkForm);
    });

    addHomeworkButton.addEventListener('click', async () => {
        if (!currentCreator) return;
        
        addHomeworkButton.disabled = true;
        addHomeworkButton.textContent = 'در حال ذخیره...';

        const homeworkData = {
            classname: classSelect.value,
            date: homeworkDate.value.trim(),
            homework: homeworkDetails.value.trim(),
            creator: currentCreator
        };

        try {
            const { error: homeworkError } = await db.from('homeworks').insert([homeworkData]);
            if (homeworkError) throw homeworkError;
            
            // FIX: Reverted to sending the timestamp explicitly from the client
            const { error: announcementError } = await db.from('announcements').insert([{
                message: `تکلیف جدیدی برای کلاس ${homeworkData.classname} ثبت شد.`,
                created_at: new Date().toISOString()
            }]);
            if (announcementError) throw announcementError;

            classSelect.value = '';
            homeworkDate.value = '';
            homeworkDetails.value = '';
            hideModal(homeworkModal);
        } catch (e) {
            console.error("Error adding document: ", e);
            alert("خطا در ذخیره سازی اطلاعات. لطفا دوباره تلاش کنید.");
        } finally {
            addHomeworkButton.disabled = false;
            addHomeworkButton.textContent = 'افزودن تکلیف';
            validateHomeworkForm();
        }
    });

    // ============================================
    // Real-time Announcements Listener
    // ============================================
    async function fetchAndRenderAnnouncements() {
        const { data, error } = await db
            .from('announcements')
            .select('*')
            .order('created_at', { ascending: false })
            .limit(10);

        if (error) {
            console.error("Error fetching announcements:", error);
            return;
        }
        
        if (!data || data.length === 0) {
            announcementsList.innerHTML = `<p style="color:var(--muted)">هنوز اعلانی ثبت نشده است.</p>`;
            return;
        }

        let announcementsHTML = '';
        const formatter = new Intl.DateTimeFormat('fa-IR', { weekday: 'long', hour: '2-digit', minute: '2-digit' });
        data.forEach(announcement => {
            const timeString = formatter.format(new Date(announcement.created_at));
            announcementsHTML += `
                <div class="p-3 rounded-md flex justify-between items-center" style="background-color: var(--card);">
                    <span>${announcement.message}</span>
                    <span class="text-xs" style="color:var(--muted);">${timeString}</span>
                </div>
            `;
        });
        announcementsList.innerHTML = announcementsHTML;
    }

    function listenForAnnouncements() {
        db.channel('public:announcements')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'announcements' }, payload => {
                console.log('New announcement received!', payload);
                fetchAndRenderAnnouncements();
            })
            .subscribe();
    }
    
    // NEW: Debug function to fetch all data
    async function getAllData() {
        console.log("--- Fetching All Data ---");
        try {
            const { data: homeworks, error: hwError } = await db.from('homeworks').select('*');
            if (hwError) throw hwError;
            console.log("Homeworks:", homeworks);

            const { data: announcements, error: anError } = await db.from('announcements').select('*');
            if (anError) throw anError;
            console.log("Announcements:", announcements);

            const { data: representatives, error: repError } = await db.from('representatives').select('*');
            if (repError) throw repError;
            console.log("Representatives:", representatives);

        } catch (error) {
            console.error("Error fetching all data:", error);
        }
        console.log("-------------------------");
    }
    // Make it accessible from the console
    window.getAllData = getAllData;

    // ============================================
    // Initialization
    // ============================================
    function init() {
        createBlocks();
        createParticles();
        fetchAndRenderAnnouncements(); // Initial fetch
        listenForAnnouncements(); // Listen for real-time updates
        
        const initialTheme = localStorage.getItem('theme') || 'dark';
        applyTheme(initialTheme);
        themeToggle.addEventListener('click', () => applyTheme(document.body.dataset.theme === 'dark' ? 'light' : 'dark'));

        const savedCreator = sessionStorage.getItem('currentCreator');
        if (savedCreator) {
            updateUIForLogin(savedCreator);
        }

        classNames.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = `کلاس ${name}`;
            classSelect.appendChild(option);
        });
    }
    
    window.addEventListener('resize', createParticles);
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (loginModal.classList.contains('visible')) hideModal(loginModal);
        else if (homeworkModal.classList.contains('visible')) hideModal(homeworkModal);
        else if (activeClone) closeFullscreen();
      }
    });
    
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
